<!DOCTYPE html>
<head>
    <meta charset="utf-8"/>
    <title>자모 분석기</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,user-scalable=yes">
    <script src="//code.jquery.com/jquery.min.js" type="text/javascript"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
    <style>*{word-wrap:break-word;max-width:100%}</style>
</head>
<body class="container">
    <div class="col-md-6">
        <h1 class="row"><a href=".">자모 분석기</a></h1>
        <hr class="row"/>
        <input id="fileInput" class="row" type="file"></input>
        <br class="row"/>
        <textarea id="textInput" class="row resize" style="width:100%" rows="10"></textarea>
        <div class="row"></div>
        <button id="processButton" class="row btn btn-default">분석</button>
        <div class="row"><br/></div>
        <div id="textOutput" class="row well well-md"></div>
    </div>

<script>
(function() {
    function inherit(subType, superType){
        function O() {}
        O.prototype = superType.prototype;
        var prototype = new O();
        prototype.constructor = subType;
        subType.prototype = prototype;
    }

    function splitToSentences(text) {
        var sentences = [];
        text.split(".%").forEach(function(entry) {
            if(entry)
                sentences.push(new Sentence(entry));
        });
        return sentences;
    }

    function Sentence(text) {
        this.text = text;
        this.words = this.splitToWords(text);
    }

    Sentence.prototype.splitToWords = function(sentence) {
        var words = [];
        sentence.split(/#,?/).forEach(function(entry) {
            if(entry)
                words.push(new Word(entry));
        });
        return words;
    };

    function Word(text) {
        this.text = text;
//        this.syllables = this.splitToSyllables(text);
    }
/*
    Word.prototype.splitToSyllables = function(word) {
        var syllables = [];
        word.split("$").forEach(function(entry) {
            if(entry)
                syllables.push(entry);
        });
        return syllables;
    };
*/
    var choseongs = [ "ㄱ", "ㄲ", "ㄴ", "ㄷ", "ㄸ", "ㄹ", "ㅁ", "ㅂ", "ㅃ", "ㅅ", "ㅆ", "ㅇ", "ㅈ", "ㅉ", "ㅊ", "ㅋ", "ㅌ", "ㅍ", "ㅎ" ];
    var jungseongs = [ "ㅏ", "ㅐ", "ㅑ", "ㅒ", "ㅓ", "ㅔ", "ㅕ", "ㅖ", "ㅗ", "ㅘ", "ㅙ", "ㅚ", "ㅛ", "ㅜ", "ㅝ", "ㅞ", "ㅟ", "ㅠ", "ㅡ", "ㅢ", "ㅣ" ];
    var jongseongs = [ "", "ㄱ", "ㄲ", "ㄳ", "ㄴ", "ㄵ", "ㄶ", "ㄷ", "ㄹ", "ㄺ", "ㄻ", "ㄼ", "ㄽ", "ㄾ", "ㄿ", "ㅀ", "ㅁ", "ㅂ", "ㅄ", "ㅅ", "ㅆ", "ㅇ", "ㅈ", "ㅊ", "ㅋ", "ㅌ", "ㅍ", "ㅎ" ];

    function isSyllable(character) {
        return (0xAC00 <= character.charCodeAt(0) && character.charCodeAt(0) <= 0xD79F);
    }

    function isChoseong(character) {
        return (choseongs.indexOf(character) != -1);
    }

    function isJungseong(character) {
        return (jungseongs.indexOf(character) != -1);
    }

    function isJongseong(character) {
        return (character != "" && jongseongs.indexOf(character) != -1);
    }

    function syllableToJamos(syllable) {
        var choseong, jungseong, jongseong;
        jongseong = (syllable.charCodeAt(0) - 0xAC00) % 28;
        jungseong = ((syllable.charCodeAt(0) - 0xAC00 - jongseong) / 28) % 21
        choseong = (((syllable.charCodeAt(0) - 0xAC00 - jongseong) / 28) - jungseong) / 21
        return [choseongs[choseong], jungseongs[jungseong], jongseongs[jongseong]];
    }

    function jamosToSyllable(jamos) {
        return String.fromCharCode(0xAC00 + 28 * 21 * choseongs.indexOf(jamos[0]) + 28 * jungseongs.indexOf(jamos[1]) + jongseongs.indexOf(jamos[2]));
    }

    function normalizeText(inputText) {
        return inputText.replace(/\n+/g, "").replace(/\. +/g, ".").replace(/, +/g, ",").replace(/ +/g, " ");
    }

    function disassembleText(inputText) {
        var disassembledText = [];
        var choseongCount = 0;
        var jungseongCount = 0;
        var jongseongCount = 0;
   
        inputText = normalizeText(inputText);

        for(var i = 0; i < inputText.length; i++) {
            var character = inputText.charAt(i);
            if(isSyllable(character)) {
                var jamos = syllableToJamos(character);
                disassembledText.push(jamos[0]);
                ++choseongCount;
                disassembledText.push(jamos[1]);
                ++jungseongCount;
                if(isJongseong(jamos[2])) {
                    disassembledText.push(jamos[2]);
                    ++jongseongCount;
                }
                disassembledText.push("$");
            } else if(character == " ") {
                disassembledText.push("#");
            } else if(character == ",") {
                disassembledText.push("#,");
            } else if(character == ".") {
                disassembledText.push("#.%");
            } else if(isChoseong(character)) {
                disassembledText.push(character);
                ++choseongCount;
            } else if(isJungseong(character)) {
                disassembledText.push(character);
                ++jungseongCount;
            } else {
                disassembledText.push(character);
            }
        }

        return {
             disassembledText: disassembledText.join(""),
             choseongCount: choseongCount,
             jungseongCount: jungseongCount,
             jongseongCount: jongseongCount
        };
    }

    if(!(File && FileReader && FileList && Blob)) {
        alert("File API Not Supported!");
        throw new Error("File API Not Supported!");
    }

    function escapeHtml(htmlText) {
        return htmlText
             .replace(/&/g, "&amp;")
             .replace(/</g, "&lt;")
             .replace(/>/g, "&gt;")
             .replace(/"/g, "&quot;") // "
             .replace(/'/g, "&#039;");
    }

    var fileInput = document.getElementById("fileInput");
    var textInput = document.getElementById("textInput");
    var processButton = document.getElementById("processButton");
    var textOutput = document.getElementById("textOutput");
 
    fileInput.addEventListener("change", function(event) {
        var file = fileInput.files[0];
        var fileReader = new FileReader();
        fileReader.onload = function(event) {
            textInput.value = fileReader.result;
        };
        fileReader.readAsText(file);
    });

    processButton.addEventListener("click", function(event) {
        var outputModel = disassembleText(escapeHtml(textInput.value));
        var sentences = console.log(splitToSentences(outputModel.disassembledText));
        textOutput.innerHTML = outputModel.disassembledText + "<br/><br/>" + "초성: " + outputModel.choseongCount + "개<br/>" + "중성: " + outputModel.jungseongCount + "개<br/>" + "종성: " + outputModel.jongseongCount + "개";
    });
}());
</script>
</body>
</html>
